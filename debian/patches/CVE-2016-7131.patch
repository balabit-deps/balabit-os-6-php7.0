Description: fix denial of service and possible code execution via
 malformed wddxPacket XML document
Bug: https://bugs.php.net/bug.php?id=72790
Origin: backport, http://git.php.net/?p=php-src.git;a=commit;h=0c8a2a2cd1056b7dc403eacb5d2c0eec6ce47c6f
Origin: backport, http://git.php.net/?p=php-src.git;a=commit;h=5a34bd6d1e6b4d31221c50bcf477c9508553a646
Origin: backport, http://git.php.net/?p=php-src.git;a=commit;h=0d13325b660b5ae64267dffcc9a153c7634fdfe2

Index: php7.0-7.0.8/ext/wddx/tests/bug72790.phpt
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php7.0-7.0.8/ext/wddx/tests/bug72790.phpt	2016-10-03 12:38:24.517715851 -0400
@@ -0,0 +1,35 @@
+--TEST--
+Bug 72790: wddx_deserialize null dereference with invalid xml
+--SKIPIF--
+<?php
+if (!extension_loaded('wddx')) {
+    die('skip. wddx not available');
+}
+?>
+--FILE--
+<?php
+
+$xml = <<< XML
+<?xml version='1.0' ?>
+<!DOCTYPE wddxPacket SYSTEM 'wddx_0100.dtd'>
+<wddxPacket version='1.0'>
+        |array>
+                <var name="XXXX">
+                        <boolean value="this">
+                        </boolean>
+                </var>
+                <var name="YYYY">
+                        <var name="UUUU">
+                                <var name="EZEZ">
+                                </var>
+                        </var>
+                </var>
+        </array>
+</wddxPacket>
+XML;
+
+$array = wddx_deserialize($xml);
+var_dump($array);
+?>
+--EXPECT--
+NULL
\ No newline at end of file
Index: php7.0-7.0.8/ext/wddx/tests/bug72799.phpt
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php7.0-7.0.8/ext/wddx/tests/bug72799.phpt	2016-10-03 12:38:24.517715851 -0400
@@ -0,0 +1,28 @@
+--TEST--
+Bug #72799: wddx_deserialize null dereference in php_wddx_pop_element
+--SKIPIF--
+<?php
+if (!extension_loaded('wddx')) {
+    die('skip. wddx not available');
+}
+?>
+--FILE--
+<?php
+
+$xml = <<<XML
+<?xml version='1.0'?>
+<!DOCTYPE wddxPacket SYSTEM 'wddx_0100.dtd'>
+<wddxPacket version="1.0">
+    <var name="XXXX">
+        <boolean value="1">
+            <dateTime>1998-06-12T04:32:12+00</dateTime>
+        </boolean>
+    </var>
+</wddxPacket>
+XML;
+
+$array = wddx_deserialize($xml);
+var_dump($array);
+?>
+--EXPECT--
+NULL
\ No newline at end of file
Index: php7.0-7.0.8/ext/wddx/wddx.c
===================================================================
--- php7.0-7.0.8.orig/ext/wddx/wddx.c	2016-06-21 15:56:42.000000000 -0400
+++ php7.0-7.0.8/ext/wddx/wddx.c	2016-10-03 12:38:27.017743877 -0400
@@ -881,10 +881,10 @@
 		if (Z_TYPE(ent1->data) == IS_UNDEF) {
 			if (stack->top > 1) {
 				stack->top--;
+				efree(ent1);
 			} else {
 				stack->done = 1;
 			}
-			efree(ent1);
 			return;
 		}
 
@@ -912,7 +912,7 @@
 			wddx_stack_top(stack, (void**)&ent2);
 
 			/* if non-existent field */
-			if (ent2->type == ST_FIELD && Z_ISUNDEF(ent2->data)) {
+			if (Z_ISUNDEF(ent2->data)) {
 				zval_ptr_dtor(&ent1->data);
 				efree(ent1);
 				return;
@@ -1038,7 +1038,6 @@
 				if (Z_LVAL(ent->data) == -1) {
 					ZVAL_STRINGL(&ent->data, (char *)s, len);
 				}
-				efree(tmp);
 			}
 				break;
 
@@ -1072,8 +1071,12 @@
 
 	if (stack.top == 1) {
 		wddx_stack_top(&stack, (void**)&ent);
-		ZVAL_COPY(return_value, &ent->data);
-		retval = SUCCESS;
+		if (IS_UNDEF(ent->data)) {
+			retval = FAILURE;
+		} else {
+			ZVAL_COPY(return_value, &ent->data);
+			retval = SUCCESS;
+		}
 	} else {
 		retval = FAILURE;
 	}
