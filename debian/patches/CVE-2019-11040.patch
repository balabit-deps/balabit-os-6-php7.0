From 73ff4193be24192c894dc0502d06e2b2db35eefb Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Mon, 27 May 2019 17:16:29 -0700
Subject: [PATCH] Fix bug #77988 - heap-buffer-overflow on php_jpg_get16

---
 NEWS                         |   8 ++++++--
 ext/exif/exif.c              |   2 ++
 ext/exif/tests/bug77988.jpg  | Bin 0 -> 1202 bytes
 ext/exif/tests/bug77988.phpt |  11 +++++++++++
 4 files changed, 19 insertions(+), 2 deletions(-)
 create mode 100644 ext/exif/tests/bug77988.jpg
 create mode 100644 ext/exif/tests/bug77988.phpt

Index: php7.0-7.0.33/ext/exif/exif.c
===================================================================
--- php7.0-7.0.33.orig/ext/exif/exif.c	2019-06-04 13:13:10.044419598 -0400
+++ php7.0-7.0.33/ext/exif/exif.c	2019-06-04 13:13:10.044419598 -0400
@@ -3525,6 +3525,8 @@ static int exif_scan_thumbnail(image_inf
 		if (c == 0xFF)
 			return FALSE;
 		marker = c;
+		if (pos>=ImageInfo->Thumbnail.size)
+			return FALSE;
 		length = php_jpg_get16(data+pos);
 		if (length > ImageInfo->Thumbnail.size || pos >= ImageInfo->Thumbnail.size - length) {
 			return FALSE;
