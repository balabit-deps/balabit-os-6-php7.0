Description: fix denial of service or code execution via crafted serialized data
Bug: https://bugs.php.net/bug.php?id=73029
Origin: backport, http://git.php.net/?p=php-src.git;a=commit;h=022e75cba104c52ccfb494ce224c2c4d0ff2dddc
Origin: backport, http://git.php.net/?p=php-src.git;a=commit;h=ecb7f58a069be0dec4a6131b6351a761f808f22e
Origin: backport, http://git.php.net/?p=php-src.git;a=commit;h=fab33740c5d6541653277ffc7443022730f444a7

Index: php7.0-7.0.8/ext/spl/spl_array.c
===================================================================
--- php7.0-7.0.8.orig/ext/spl/spl_array.c	2016-06-21 15:56:58.000000000 -0400
+++ php7.0-7.0.8/ext/spl/spl_array.c	2016-10-03 13:01:47.965450535 -0400
@@ -295,7 +295,7 @@
 	zend_string *offset_key;
 	HashTable *ht = spl_array_get_hash_table(intern);
 
-	if (!offset || Z_ISUNDEF_P(offset)) {
+	if (!offset || Z_ISUNDEF_P(offset) || !ht) {
 		return &EG(uninitialized_zval);
 	}
 
@@ -1796,7 +1796,8 @@
 		intern->ar_flags |= flags & SPL_ARRAY_CLONE_MASK;
 		zval_ptr_dtor(&intern->array);
 		ZVAL_UNDEF(&intern->array);
-		if (!php_var_unserialize(&intern->array, &p, s + buf_len, &var_hash)) {
+		if (!php_var_unserialize(&intern->array, &p, s + buf_len, &var_hash)
+				|| (Z_TYPE(intern->array) != IS_ARRAY && Z_TYPE(intern->array) != IS_OBJECT)) {
 			goto outexcept;
 		}
 		var_push_dtor(&var_hash, &intern->array);
Index: php7.0-7.0.8/ext/spl/tests/bug70068.phpt
===================================================================
--- php7.0-7.0.8.orig/ext/spl/tests/bug70068.phpt	2016-06-21 15:56:58.000000000 -0400
+++ php7.0-7.0.8/ext/spl/tests/bug70068.phpt	2016-10-03 13:01:51.961495336 -0400
@@ -2,8 +2,13 @@
 Bug #70068 (Dangling pointer in the unserialization of ArrayObject items)
 --FILE--
 <?php
+try {
 $a = unserialize('a:3:{i:0;C:11:"ArrayObject":20:{x:i:0;r:3;;m:a:0:{};}i:1;d:11;i:2;S:31:"AAAAAAAABBBBCCCC\01\00\00\00\04\00\00\00\00\00\00\00\00\00\00";}');
+} catch(Exception $e) {
+	print $e->getMessage()."\n";
+}
 ?>
 OK
 --EXPECT--
+Error at offset 10 of 20 bytes
 OK
\ No newline at end of file
Index: php7.0-7.0.8/ext/spl/tests/bug73029.phpt
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php7.0-7.0.8/ext/spl/tests/bug73029.phpt	2016-10-03 13:01:47.965450535 -0400
@@ -0,0 +1,16 @@
+--TEST--
+Bug #73029: Missing type check when unserializing SplArray
+--FILE--
+<?php
+try {
+$a = 'C:11:"ArrayObject":19:0x:i:0;r:2;;m:a:0:{}}';
+$m = unserialize($a);
+$x = $m[2];
+} catch(UnexpectedValueException $e) {
+	print $e->getMessage() . "\n";
+}
+?>
+DONE
+--EXPECTF--
+Error at offset 10 of 19 bytes
+DONE
