From 78bd3477745f1ada9578a79f61edb41886bec1cb Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sat, 29 Dec 2018 18:25:37 -0800
Subject: [PATCH] Fix bug #77247 (heap buffer overflow in
 phar_detect_phar_fname_ext)

---
 ext/phar/phar.c              |  2 +-
 ext/phar/tests/bug77247.phpt | 14 ++++++++++++++
 2 files changed, 15 insertions(+), 1 deletion(-)
 create mode 100644 ext/phar/tests/bug77247.phpt

Index: php7.0-7.0.33/ext/phar/phar.c
===================================================================
--- php7.0-7.0.33.orig/ext/phar/phar.c	2019-03-05 07:39:23.421640293 -0500
+++ php7.0-7.0.33/ext/phar/phar.c	2019-03-05 07:39:23.413640227 -0500
@@ -2021,7 +2021,7 @@ next_extension:
 	}
 
 	while (pos != filename && (*(pos - 1) == '/' || *(pos - 1) == '\0')) {
-		pos = memchr(pos + 1, '.', filename_len - (pos - filename) + 1);
+		pos = memchr(pos + 1, '.', filename_len - (pos - filename) - 1);
 		if (!pos) {
 			return FAILURE;
 		}
Index: php7.0-7.0.33/ext/phar/tests/bug77247.phpt
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php7.0-7.0.33/ext/phar/tests/bug77247.phpt	2019-03-05 07:39:23.413640227 -0500
@@ -0,0 +1,14 @@
+--TEST--
+PHP bug #77247 (heap buffer overflow in phar_detect_phar_fname_ext)
+--SKIPIF--
+<?php if (!extension_loaded("phar")) die("skip"); ?>
+--FILE--
+<?php
+try {
+var_dump(new Phar('a/.b', 0,'test.phar'));
+} catch(UnexpectedValueException $e) {
+	echo "OK";
+}
+?>
+--EXPECT--
+OK
\ No newline at end of file
