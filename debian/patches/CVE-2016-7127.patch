From e70069a62fb7252252cad9506fac5baf4ac11d21 Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Wed, 10 Aug 2016 00:14:58 -0700
Subject: [PATCH] Fix bug #72730 - imagegammacorrect allows arbitrary write
 access

(cherry picked from commit 047fe0ed03093a496691d376fcf51a7e2f1d04b0)

Conflicts:
	ext/gd/gd.c
---
 ext/gd/gd.c                |  5 +++++
 ext/gd/tests/bug72730.phpt | 15 +++++++++++++++
 2 files changed, 20 insertions(+)
 create mode 100644 ext/gd/tests/bug72730.phpt

Index: php7.0-7.0.8/ext/gd/gd.c
===================================================================
--- php7.0-7.0.8.orig/ext/gd/gd.c	2016-10-03 13:32:06.065834076 -0400
+++ php7.0-7.0.8/ext/gd/gd.c	2016-10-03 13:32:32.206127146 -0400
@@ -3013,6 +3013,11 @@
 		return;
 	}
 
+	if ( input <= 0.0 || output <= 0.0 ) {
+		php_error_docref(NULL TSRMLS_CC, E_WARNING, "Gamma values should be positive");
+		RETURN_FALSE;
+	}
+
 	if ((im = (gdImagePtr)zend_fetch_resource(Z_RES_P(IM), "Image", le_gd)) == NULL) {
 		RETURN_FALSE;
 	}
Index: php7.0-7.0.8/ext/gd/tests/bug72730.phpt
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php7.0-7.0.8/ext/gd/tests/bug72730.phpt	2016-10-03 13:32:06.065834076 -0400
@@ -0,0 +1,15 @@
+--TEST--
+Bug #72730: imagegammacorrect allows arbitrary write access
+--SKIPIF--
+<?php 
+if (!function_exists("imagecreatetruecolor")) die("skip");
+?>
+--FILE--
+<?php
+$img =  imagecreatetruecolor(1, 1);
+imagegammacorrect($img, -1, 1337);
+?>
+DONE
+--EXPECTF--
+Warning: imagegammacorrect(): Gamma values should be positive in %sbug72730.php on line %d
+DONE
\ No newline at end of file
