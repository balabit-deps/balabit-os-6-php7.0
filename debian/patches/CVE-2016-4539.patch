Backport of:

From dccda88f27a084bcbbb30198ace12b4e7ae961cc Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sun, 24 Apr 2016 23:50:57 -0700
Subject: [PATCH] Fix bug #72099: xml_parse_into_struct segmentation fault

---
 ext/xml/tests/bug72099.phpt |  17 +++++++
 ext/xml/xml.c               | 106 ++++++++++++++++++++++----------------------
 2 files changed, 70 insertions(+), 53 deletions(-)
 create mode 100644 ext/xml/tests/bug72099.phpt

Index: php7.0-7.0.4/ext/xml/tests/bug72099.phpt
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php7.0-7.0.4/ext/xml/tests/bug72099.phpt	2016-05-17 13:11:43.477978903 -0400
@@ -0,0 +1,17 @@
+--TEST--
+Bug #72099: xml_parse_into_struct segmentation fault
+--SKIPIF--
+<?php
+require_once("skipif.inc");
+?>
+--FILE--
+<?php
+$var1=xml_parser_create_ns();
+$var2=str_repeat("a", 10);
+$var3=[];
+$var4=[];
+xml_parse_into_struct($var1, $var2, $var3, $var4);
+var_dump($var3);
+--EXPECT--
+array(0) {
+}
\ No newline at end of file
Index: php7.0-7.0.4/ext/xml/xml.c
===================================================================
--- php7.0-7.0.4.orig/ext/xml/xml.c	2016-05-17 13:11:43.477978903 -0400
+++ php7.0-7.0.4/ext/xml/xml.c	2016-05-17 13:12:45.174768544 -0400
@@ -920,7 +920,7 @@
 						break;
 					} ZEND_HASH_FOREACH_END();
 
-					if (parser->level <= XML_MAXLEVEL) {
+					if (parser->level <= XML_MAXLEVEL && parser->level > 0) {
 						array_init(&tag);
 
 						_xml_add_to_info(parser,parser->ltags[parser->level-1] + parser->toffset);
