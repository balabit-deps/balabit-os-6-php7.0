Backport of:

From fd9689745c44341b1bd6af4756f324be8abba2fb Mon Sep 17 00:00:00 2001
From: Stanislav Malyshev <stas@php.net>
Date: Sun, 24 Apr 2016 12:49:01 -0700
Subject: [PATCH] Fix bug #72061 - Out-of-bounds reads in zif_grapheme_stripos
 with negative offset

---
 ext/intl/grapheme/grapheme_string.c | 12 +++++++-----
 ext/intl/tests/bug72061.phpt        | 15 +++++++++++++++
 2 files changed, 22 insertions(+), 5 deletions(-)
 create mode 100644 ext/intl/tests/bug72061.phpt

Index: php7.0-7.0.4/ext/intl/grapheme/grapheme_string.c
===================================================================
--- php7.0-7.0.4.orig/ext/intl/grapheme/grapheme_string.c	2016-05-17 13:13:53.959648810 -0400
+++ php7.0-7.0.4/ext/intl/grapheme/grapheme_string.c	2016-05-17 13:15:30.798369183 -0400
@@ -110,7 +110,7 @@
 	size_t haystack_len, needle_len;
 	const char *found;
 	zend_long loffset = 0;
-	int32_t offset = 0;
+	int32_t offset = 0, noffset = 0;
 	zend_long ret_pos;
 
 	if (zend_parse_parameters(ZEND_NUM_ARGS(), "ss|l", &haystack, &haystack_len, &needle, &needle_len, &loffset) == FAILURE) {
@@ -126,6 +126,7 @@
 
 	/* we checked that it will fit: */
 	offset = (int32_t) loffset;
+	noffset = offset >= 0 ? offset : haystack_len + offset;
 
 	/* the offset is 'grapheme count offset' so it still might be invalid - we'll check it later */
 
@@ -138,7 +139,7 @@
 	/* quick check to see if the string might be there
 	 * I realize that 'offset' is 'grapheme count offset' but will work in spite of that
 	*/
-	found = php_memnstr(haystack + offset, needle, needle_len, haystack + haystack_len);
+	found = (unsigned char *)php_memnstr((char *)haystack + noffset, (char *)needle, needle_len, (char *)haystack + haystack_len);
 
 	/* if it isn't there the we are done */
 	if (!found) {
@@ -199,12 +200,13 @@
 	is_ascii = ( grapheme_ascii_check((unsigned char*)haystack, haystack_len) >= 0 );
 
 	if ( is_ascii ) {
+		int32_t noffset = offset >= 0 ? offset : haystack_len + offset;
 		needle_dup = estrndup(needle, needle_len);
 		php_strtolower(needle_dup, needle_len);
 		haystack_dup = estrndup(haystack, haystack_len);
 		php_strtolower(haystack_dup, haystack_len);
 
-		found = php_memnstr(haystack_dup + offset, needle_dup, needle_len, haystack_dup + haystack_len);
+		found = (unsigned char*) php_memnstr((char *)haystack_dup + noffset, (char *)needle_dup, needle_len, (char *)haystack_dup + haystack_len);
 
 		efree(haystack_dup);
 		efree(needle_dup);
Index: php7.0-7.0.4/ext/intl/tests/bug72061.phpt
===================================================================
--- /dev/null	1970-01-01 00:00:00.000000000 +0000
+++ php7.0-7.0.4/ext/intl/tests/bug72061.phpt	2016-05-17 13:13:53.959648810 -0400
@@ -0,0 +1,15 @@
+--TEST--
+Bug #72061: Out-of-bounds reads in zif_grapheme_stripos with negative offset
+--SKIPIF--
+<?php if( !extension_loaded( 'intl' ) ) print 'skip'; ?>
+--FILE--
+<?php
+
+var_dump(grapheme_stripos(str_repeat("ABCD", 16384), "A", -201));
+var_dump(grapheme_strpos(str_repeat("ABCD", 16384), "A", -201));
+?>
+DONE
+--EXPECT--
+int(65336)
+int(65336)
+DONE
\ No newline at end of file
